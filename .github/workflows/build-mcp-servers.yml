name: Build MCP Servers

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  # å¤šå¹³å°æž„å»ºä½œä¸š
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          # Linux æž„å»º
          - os: ubuntu-latest
            platform: linux
            mcp_platform: linux
            executable_suffix: ""
            archive_format: tar.gz
            archive_name: mcp-servers-linux-amd64
          
          # Windows æž„å»º - è¿™æ˜¯å…³é”®ï¼
          - os: windows-latest
            platform: windows
            mcp_platform: windows
            executable_suffix: .exe
            archive_format: zip
            archive_name: mcp-servers-windows-amd64
          
          # macOS æž„å»º
          - os: macos-latest
            platform: macos
            mcp_platform: macos
            executable_suffix: ""
            archive_format: tar.gz
            archive_name: mcp-servers-macos-universal

    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. è®¾ç½® Python çŽ¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # 3. ç¼“å­˜ä¾èµ–ï¼ˆåŠ é€Ÿæž„å»ºï¼‰
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~/.local/share/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt', '**/expert_stream_server_requirements.txt', '**/terminal_stream_server_requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # 4. å®‰è£…ä¾èµ–
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
        pip install -r expert_stream_server/expert_stream_server_requirements.txt
        pip install -r terminal_manager_server/terminal_stream_server_requirements.txt

    # 5. è¿è¡Œæµ‹è¯•ï¼ˆå¯é€‰ï¼‰
    - name: Run tests
      run: |
        python -m pytest tests/ || echo "No tests found"

    # 6. æ£€æŸ¥ mcp-build å·¥å…·
    - name: Check mcp-build availability
      run: |
        mcp-build --help || echo "mcp-build not found, installing..."
        pip install mcp-framework

    # 7. ä½¿ç”¨ mcp-build æž„å»ºæ‰€æœ‰æœåŠ¡å™¨
    - name: Build all servers with mcp-framework
      run: |
        # æž„å»ºæ–‡ä»¶è¯»å–æœåŠ¡å™¨
        mcp-build --platform ${{ matrix.mcp_platform }} --server file_reader_server/file_reader_server.py
        
        # æž„å»ºç»ˆç«¯ç®¡ç†æœåŠ¡å™¨
        mcp-build --platform ${{ matrix.mcp_platform }} --server terminal_manager_server/terminal_stream_server.py
        
        # æž„å»ºAIä¸“å®¶æœåŠ¡å™¨
        mcp-build --platform ${{ matrix.mcp_platform }} --server expert_stream_server/expert_stream_server.py

    # 8. æ•´ç†æž„å»ºäº§ç‰©
    - name: Organize build artifacts
      run: |
        # åˆ›å»ºç»Ÿä¸€çš„ dist ç›®å½•
        mkdir -p dist
        
        # æŸ¥æ‰¾å¹¶ç§»åŠ¨æž„å»ºäº§ç‰©åˆ° dist ç›®å½•
        find . -name "*-server*" -type f -executable -not -path "./dist/*" -exec mv {} dist/ \;
        
        # æ˜¾ç¤ºæž„å»ºç»“æžœ
        echo "Build artifacts:"
        ls -la dist/

    # 10. Windows ç‰¹æ®Šå¤„ç†ï¼šä»£ç ç­¾åï¼ˆå¯é€‰ï¼‰
    - name: Sign Windows executables
      if: matrix.platform == 'windows'
      run: |
        echo "Windows executables built:"
        dir dist
        # è¿™é‡Œå¯ä»¥æ·»åŠ ä»£ç ç­¾åæ­¥éª¤
        # signtool sign /f certificate.p12 /p password dist/*.exe

    # 11. åˆ›å»ºå‘å¸ƒåŒ…
    - name: Create release archive
      shell: bash
      run: |
        cd dist
        if [ "${{ matrix.platform }}" = "windows" ]; then
          7z a ../${{ matrix.archive_name }}.zip *${{ matrix.executable_suffix }}
        else
          tar -czf ../${{ matrix.archive_name }}.tar.gz *
        fi

    # 12. ä¸Šä¼ æž„å»ºäº§ç‰©
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.archive_name }}
        path: |
          ${{ matrix.archive_name }}.*
        retention-days: 30

    # 13. æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
    - name: Test executables
      shell: bash
      run: |
        cd dist
        echo "Testing built executables:"
        for exe in *${{ matrix.executable_suffix }}; do
          if [ -f "$exe" ]; then
            echo "Testing $exe..."
            ./$exe --help || echo "Help command failed for $exe"
          fi
        done

  # åˆ›å»º GitHub Release
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Display downloaded files
      run: |
        find artifacts/ -type f -name "*" | head -20

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*/*
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## MCP Servers Release
          
          This release includes pre-built executables for all three MCP servers:
          
          ### ðŸ“¦ Included Servers
          - **File Reader Server** - æ–‡ä»¶è¯»å–å’Œé¡¹ç›®ç»“æž„åˆ†æžæœåŠ¡
          - **Terminal Manager Server** - ç»ˆç«¯ç®¡ç†å’Œå‘½ä»¤æ‰§è¡ŒæœåŠ¡  
          - **Expert Stream Server** - AIä¸“å®¶å¯¹è¯å’Œå·¥å…·è°ƒç”¨æœåŠ¡
          
          ### ðŸš€ Quick Start
          1. Download the archive for your platform
          2. Extract the executables
          3. Run any server directly: `./file-reader-server`, `./terminal-manager-server`, or `./expert-stream-server`
          
          ### ðŸ“‹ Platform Support
          - **Linux**: `mcp-servers-linux-amd64.tar.gz`
          - **Windows**: `mcp-servers-windows-amd64.zip`
          - **macOS**: `mcp-servers-macos-universal.tar.gz`
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æž„å»º Docker é•œåƒï¼ˆLinux ç‰ˆæœ¬ï¼‰
  docker:
    name: Build Docker Images
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}
      continue-on-error: true

    - name: Create Dockerfiles
      run: |
        # åˆ›å»ºæ–‡ä»¶è¯»å–æœåŠ¡å™¨çš„ Dockerfile
        cat > Dockerfile.file-reader << 'EOF'
        FROM python:3.11-slim
        WORKDIR /app
        COPY requirements.txt .
        RUN pip install -r requirements.txt
        COPY file_reader_server/ ./file_reader_server/
        EXPOSE 8000
        CMD ["python", "file_reader_server/file_reader_server.py"]
        EOF
        
        # åˆ›å»ºç»ˆç«¯ç®¡ç†æœåŠ¡å™¨çš„ Dockerfile
        cat > Dockerfile.terminal-manager << 'EOF'
        FROM python:3.11-slim
        WORKDIR /app
        COPY requirements.txt .
        COPY terminal_manager_server/terminal_stream_server_requirements.txt ./terminal_requirements.txt
        RUN pip install -r requirements.txt && pip install -r terminal_requirements.txt
        COPY terminal_manager_server/ ./terminal_manager_server/
        EXPOSE 8080
        CMD ["python", "terminal_manager_server/terminal_stream_server.py"]
        EOF
        
        # åˆ›å»ºAIä¸“å®¶æœåŠ¡å™¨çš„ Dockerfile
        cat > Dockerfile.expert-stream << 'EOF'
        FROM python:3.11-slim
        WORKDIR /app
        COPY requirements.txt .
        COPY expert_stream_server/expert_stream_server_requirements.txt ./expert_requirements.txt
        RUN pip install -r requirements.txt && pip install -r expert_requirements.txt
        COPY expert_stream_server/ ./expert_stream_server/
        EXPOSE 8005
        CMD ["python", "expert_stream_server/expert_stream_server.py"]
        EOF

    - name: Build and push Docker images
      run: |
        # æž„å»ºå¹¶æŽ¨é€æ–‡ä»¶è¯»å–æœåŠ¡å™¨é•œåƒ
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          --push \
          -f Dockerfile.file-reader \
          -t ${{ secrets.DOCKER_USERNAME }}/mcp-file-reader:latest \
          -t ${{ secrets.DOCKER_USERNAME }}/mcp-file-reader:${{ github.sha }} \
          . || echo "Docker build failed for file-reader"
        
        # æž„å»ºå¹¶æŽ¨é€ç»ˆç«¯ç®¡ç†æœåŠ¡å™¨é•œåƒ
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          --push \
          -f Dockerfile.terminal-manager \
          -t ${{ secrets.DOCKER_USERNAME }}/mcp-terminal-manager:latest \
          -t ${{ secrets.DOCKER_USERNAME }}/mcp-terminal-manager:${{ github.sha }} \
          . || echo "Docker build failed for terminal-manager"
        
        # æž„å»ºå¹¶æŽ¨é€AIä¸“å®¶æœåŠ¡å™¨é•œåƒ
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          --push \
          -f Dockerfile.expert-stream \
          -t ${{ secrets.DOCKER_USERNAME }}/mcp-expert-stream:latest \
          -t ${{ secrets.DOCKER_USERNAME }}/mcp-expert-stream:${{ github.sha }} \
          . || echo "Docker build failed for expert-stream"
      continue-on-error: true