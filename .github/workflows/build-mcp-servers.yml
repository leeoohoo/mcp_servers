name: Build MCP Servers (Corrected)

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      platforms:
        description: 'Select platforms to build'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - linux
          - windows
          - macos-intel
          - macos-m1m2

env:
  PYTHON_VERSION: '3.11'

jobs:
  # æ–‡ä»¶è¯»å–æœåŠ¡å™¨æ„å»ºä½œä¸š
  build-file-reader:
    name: Build File Reader Server on ${{ matrix.platform }}-${{ matrix.arch }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - os: ubuntu-latest
            platform: linux
            arch: x86_64
            mcp_platform: native
            executable_suffix: ""
            archive_format: tar.gz
            archive_name: file-reader-server-linux-x86_64

          # Windows x86_64
          - os: windows-latest
            platform: windows
            arch: x86_64
            mcp_platform: native
            executable_suffix: .exe
            archive_format: zip
            archive_name: file-reader-server-windows-x86_64

          # macOS Intel x86_64
          - os: macos-13
            platform: macos
            arch: x86_64
            mcp_platform: native
            executable_suffix: ""
            archive_format: tar.gz
            archive_name: file-reader-server-macos-intel-x86_64

          # macOS Apple Silicon ARM64 (M1/M2/M3)
          - os: macos-latest
            platform: macos
            arch: arm64
            mcp_platform: native
            executable_suffix: ""
            archive_format: tar.gz
            archive_name: file-reader-server-macos-apple-silicon-arm64

    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. è®¾ç½® Python ç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    # 3. è®¾ç½® Dockerï¼ˆä»… Linux éœ€è¦ï¼ŒWindows è·³è¿‡ Dockerï¼‰
    - name: Set up Docker Buildx
      if: matrix.mcp_platform == 'linux'
      uses: docker/setup-buildx-action@v3

    # 4. æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
    - name: Display system info
      env:
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: 1
      run: |
        echo "ğŸ–¥ï¸  ç³»ç»Ÿä¿¡æ¯:"
        echo "Runner OS: ${{ runner.os }}"
        echo "Platform: ${{ matrix.platform }}-${{ matrix.arch }}"
        echo "MCP Platform: ${{ matrix.mcp_platform }}"
        python --version
        pip --version
        python -c "import platform; print(f'Python å¹³å°: {platform.platform()}'); print(f'æœºå™¨æ¶æ„: {platform.machine()}'); print(f'å¤„ç†å™¨: {platform.processor()}')"
      shell: bash

    # 5. å®‰è£… MCP Frameworkï¼ˆä» PyPI å®‰è£…ï¼‰
    - name: Install MCP Framework
      env:
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: 1
      run: |
        echo "ğŸ“¦ å®‰è£… MCP Framework..."
        python -m pip install --upgrade pip
        # Windows å¹³å°ä½¿ç”¨æ›´ç¨³å®šçš„å®‰è£…æ–¹å¼
        if [ "${{ runner.os }}" = "Windows" ]; then
          python -m pip install mcp-framework --no-warn-script-location
        else
          pip install mcp-framework
        fi
      shell: bash

    # 6. å®‰è£…é¡¹ç›®ä¾èµ–
    - name: Install project dependencies
      env:
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: 1
      run: |
        echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
        # Windows å¹³å°ä½¿ç”¨æ›´ç¨³å®šçš„ pip å‡çº§æ–¹å¼
        if [ "${{ runner.os }}" = "Windows" ]; then
          python -m pip install --upgrade pip --no-warn-script-location || echo "pip å‡çº§è·³è¿‡"
        else
          pip install --upgrade pip
        fi
        
        # å®‰è£…åŸºç¡€ä¾èµ–
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        if [ -f file_reader_server/file_reader_server_requirements.txt ]; then
          pip install -r file_reader_server/file_reader_server_requirements.txt
        fi
        # å®‰è£…å„æœåŠ¡å™¨çš„ç‰¹å®šä¾èµ–
        if [ -f expert_stream_server/expert_stream_server_requirements.txt ]; then
          pip install -r expert_stream_server/expert_stream_server_requirements.txt
        fi
        
        if [ -f terminal_manager_server/terminal_stream_server_requirements.txt ]; then
          pip install -r terminal_manager_server/terminal_stream_server_requirements.txt
        fi
      shell: bash

    # 7. éªŒè¯ MCP Framework æ„å»ºå·¥å…·
    - name: Verify MCP Framework build tool
      run: |
        echo "ğŸ”§ éªŒè¯ MCP Framework æ„å»ºå·¥å…·..."
        python -m mcp_framework.build --help
        python -m mcp_framework.build --check-docker || echo "Docker æ£€æŸ¥å®Œæˆ"
      shell: bash

    # 8. æ„å»ºæ–‡ä»¶è¯»å–æœåŠ¡å™¨
    - name: Build File Reader Server
      if: hashFiles('file_reader_server/file_reader_server.py') != ''
      env:
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: 1
      run: |
        echo "ğŸ”¨ æ„å»ºæ–‡ä»¶è¯»å–æœåŠ¡å™¨..."
        echo "å¹³å°: ${{ matrix.mcp_platform }}, æ¶æ„: ${{ matrix.arch }}"
        # åˆ›å»ºç‹¬ç«‹çš„è¾“å‡ºç›®å½•
        mkdir -p "dist/file-reader-server"
        python -m mcp_framework.build --platform ${{ matrix.mcp_platform }} --server file_reader_server/file_reader_server.py --no-test --no-onefile --output-dir "dist/file-reader-server"
        # å¤„ç†--no-onefileæ¨¡å¼çš„ç›®å½•è¾“å‡ºç»“æ„
        cd dist/file-reader-server
        
        # æŸ¥æ‰¾æ„å»ºè¾“å‡ºç›®å½•ï¼ˆ--no-onefileä¼šåˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰æ–‡ä»¶çš„ç›®å½•ï¼‰
        build_dir=""
        for dir in */; do
          if [ -d "$dir" ] && [ -f "${dir}file-reader-server${{ matrix.executable_suffix }}" ]; then
            build_dir="$dir"
            break
          fi
        done
        
        if [ -n "$build_dir" ]; then
          echo "âœ… æ‰¾åˆ°æ„å»ºç›®å½•: $build_dir"
          # å°†æ•´ä¸ªç›®å½•é‡å‘½åä¸ºæœ€ç»ˆåç§°
          mv "$build_dir" "../file-reader-server-${{ matrix.platform }}-${{ matrix.arch }}"
          cd ..
          rm -rf "file-reader-server"
        else
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›®å½•ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰tar.gzæ–‡ä»¶éœ€è¦è§£å‹
          for tarfile in *.tar.gz; do
            if [ -f "$tarfile" ]; then
              echo "è§£å‹ $tarfile"
              tar -xzf "$tarfile"
              # æŸ¥æ‰¾è§£å‹åçš„ç›®å½•
              for dir in */; do
                if [ -d "$dir" ] && [ -f "${dir}file-reader-server${{ matrix.executable_suffix }}" ]; then
                  mv "$dir" "../file-reader-server-${{ matrix.platform }}-${{ matrix.arch }}"
                  cd ..
                  rm -rf "file-reader-server"
                  exit 0
                fi
              done
            fi
          done
          
          # å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œå°è¯•æŸ¥æ‰¾å•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
          for exe in file-reader-server*${{ matrix.executable_suffix }}; do
            if [ -f "$exe" ]; then
              mkdir -p "../file-reader-server-${{ matrix.platform }}-${{ matrix.arch }}"
              mv "$exe" "../file-reader-server-${{ matrix.platform }}-${{ matrix.arch }}/"
              cd ..
              rm -rf "file-reader-server"
              exit 0
            fi
          done
          
          echo "âŒ æœªæ‰¾åˆ°æ„å»ºè¾“å‡º"
          cd ..
          exit 1
        fi
      shell: bash

    # 9. æ„å»ºç»ˆç«¯ç®¡ç†æœåŠ¡å™¨
    - name: Build Terminal Manager Server
      if: hashFiles('terminal_manager_server/terminal_stream_server.py') != ''
      env:
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: 1
      run: |
        echo "ğŸ”¨ æ„å»ºç»ˆç«¯ç®¡ç†æœåŠ¡å™¨..."
        echo "å¹³å°: ${{ matrix.mcp_platform }}, æ¶æ„: ${{ matrix.arch }}"
        # åˆ›å»ºç‹¬ç«‹çš„è¾“å‡ºç›®å½•
        mkdir -p "dist/terminal-manager-server"
        python -m mcp_framework.build --platform ${{ matrix.mcp_platform }} --server terminal_manager_server/terminal_stream_server.py --no-test --no-onefile --output-dir "dist/terminal-manager-server"
        # å¤„ç†--no-onefileæ¨¡å¼çš„ç›®å½•è¾“å‡ºç»“æ„
        cd dist/terminal-manager-server
        
        # æŸ¥æ‰¾æ„å»ºè¾“å‡ºç›®å½•ï¼ˆ--no-onefileä¼šåˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰æ–‡ä»¶çš„ç›®å½•ï¼‰
        build_dir=""
        for dir in */; do
          if [ -d "$dir" ] && [ -f "${dir}terminal-stream-server${{ matrix.executable_suffix }}" ]; then
            build_dir="$dir"
            break
          fi
        done
        
        if [ -n "$build_dir" ]; then
          echo "âœ… æ‰¾åˆ°æ„å»ºç›®å½•: $build_dir"
          # å°†æ•´ä¸ªç›®å½•é‡å‘½åä¸ºæœ€ç»ˆåç§°
          mv "$build_dir" "../terminal-manager-server-${{ matrix.platform }}-${{ matrix.arch }}"
          cd ..
          rm -rf "terminal-manager-server"
        else
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›®å½•ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰tar.gzæ–‡ä»¶éœ€è¦è§£å‹
          for tarfile in *.tar.gz; do
            if [ -f "$tarfile" ]; then
              echo "è§£å‹ $tarfile"
              tar -xzf "$tarfile"
              # æŸ¥æ‰¾è§£å‹åçš„ç›®å½•
              for dir in */; do
                if [ -d "$dir" ] && [ -f "${dir}terminal-stream-server${{ matrix.executable_suffix }}" ]; then
                  mv "$dir" "../terminal-manager-server-${{ matrix.platform }}-${{ matrix.arch }}"
                  cd ..
                  rm -rf "terminal-manager-server"
                  exit 0
                fi
              done
            fi
          done
          
          # å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œå°è¯•æŸ¥æ‰¾å•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
          for exe in terminal-stream-server*${{ matrix.executable_suffix }}; do
            if [ -f "$exe" ]; then
              mkdir -p "../terminal-manager-server-${{ matrix.platform }}-${{ matrix.arch }}"
              mv "$exe" "../terminal-manager-server-${{ matrix.platform }}-${{ matrix.arch }}/"
              cd ..
              rm -rf "terminal-manager-server"
              exit 0
            fi
          done
          
          echo "âŒ æœªæ‰¾åˆ°æ„å»ºè¾“å‡º"
          cd ..
          exit 1
        fi
      shell: bash

    # 10. æ„å»ºAIä¸“å®¶æœåŠ¡å™¨
    - name: Build Expert Stream Server
      if: hashFiles('expert_stream_server/expert_stream_server.py') != ''
      env:
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: 1
      run: |
        echo "ğŸ”¨ æ„å»ºAIä¸“å®¶æœåŠ¡å™¨..."
        echo "å¹³å°: ${{ matrix.mcp_platform }}, æ¶æ„: ${{ matrix.arch }}"
        # åˆ›å»ºç‹¬ç«‹çš„è¾“å‡ºç›®å½•
        mkdir -p "dist/expert-stream-server"
        python -m mcp_framework.build --platform ${{ matrix.mcp_platform }} --server expert_stream_server/expert_stream_server.py --no-test --no-onefile --output-dir "dist/expert-stream-server"
        # å¤„ç†--no-onefileæ¨¡å¼çš„ç›®å½•è¾“å‡ºç»“æ„
        cd dist/expert-stream-server
        
        # æŸ¥æ‰¾æ„å»ºè¾“å‡ºç›®å½•ï¼ˆ--no-onefileä¼šåˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰æ–‡ä»¶çš„ç›®å½•ï¼‰
        build_dir=""
        for dir in */; do
          if [ -d "$dir" ] && [ -f "${dir}expert-stream-server${{ matrix.executable_suffix }}" ]; then
            build_dir="$dir"
            break
          fi
        done
        
        if [ -n "$build_dir" ]; then
          echo "âœ… æ‰¾åˆ°æ„å»ºç›®å½•: $build_dir"
          # å°†æ•´ä¸ªç›®å½•é‡å‘½åä¸ºæœ€ç»ˆåç§°
          mv "$build_dir" "../expert-stream-server-${{ matrix.platform }}-${{ matrix.arch }}"
          cd ..
          rm -rf "expert-stream-server"
        else
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›®å½•ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰tar.gzæ–‡ä»¶éœ€è¦è§£å‹
          for tarfile in *.tar.gz; do
            if [ -f "$tarfile" ]; then
              echo "è§£å‹ $tarfile"
              tar -xzf "$tarfile"
              # æŸ¥æ‰¾è§£å‹åçš„ç›®å½•
              for dir in */; do
                if [ -d "$dir" ] && [ -f "${dir}expert-stream-server${{ matrix.executable_suffix }}" ]; then
                  mv "$dir" "../expert-stream-server-${{ matrix.platform }}-${{ matrix.arch }}"
                  cd ..
                  rm -rf "expert-stream-server"
                  exit 0
                fi
              done
            fi
          done
          
          # å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œå°è¯•æŸ¥æ‰¾å•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
          for exe in expert-stream-server*${{ matrix.executable_suffix }}; do
            if [ -f "$exe" ]; then
              mkdir -p "../expert-stream-server-${{ matrix.platform }}-${{ matrix.arch }}"
              mv "$exe" "../expert-stream-server-${{ matrix.platform }}-${{ matrix.arch }}/"
              cd ..
              rm -rf "expert-stream-server"
              exit 0
            fi
          done
          
          echo "âŒ æœªæ‰¾åˆ°æ„å»ºè¾“å‡º"
          cd ..
          exit 1
        fi
      shell: bash

    # 11. æ•´ç†æ„å»ºäº§ç‰©
    - name: Organize build artifacts
      shell: bash
      env:
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: 1
      run: |
        echo "ğŸ“¦ æ•´ç†æ„å»ºäº§ç‰©..."
        
        echo "æœ€ç»ˆæ„å»ºäº§ç‰©:"
        if [ -d "dist" ]; then
          ls -la dist/
        else
          echo "âŒ æ²¡æœ‰æ‰¾åˆ° dist ç›®å½•"
          exit 1
        fi

    # 12. éªŒè¯æ„å»ºäº§ç‰©
    - name: Verify build artifacts
      shell: bash
      run: |
        echo "ğŸ§ª éªŒè¯æ„å»ºäº§ç‰©..."
        
        if [ ! -d "dist" ] || [ -z "$(ls -A dist 2>/dev/null)" ]; then
          echo "âŒ dist ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
          exit 1
        fi
        
        cd dist
        
        # å¤„ç†--no-onefileæ¨¡å¼çš„ç›®å½•ç»“æ„è¾“å‡º
        found_executable=false
        for item in *; do
          if [ -d "$item" ]; then
            # æ£€æŸ¥ç›®å½•ä¸­çš„å¯æ‰§è¡Œæ–‡ä»¶
            for exe_name in file-reader-server terminal-stream-server expert-stream-server; do
              main_exe="$item/${exe_name}${{ matrix.executable_suffix }}"
              if [ -f "$main_exe" ]; then
                echo "âœ… æ‰¾åˆ°ç›®å½•ç»“æ„: $item/"
                echo "âœ… ä¸»å¯æ‰§è¡Œæ–‡ä»¶: $main_exe"
                
                # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                ls -lh "$main_exe"
                file "$main_exe" 2>/dev/null || echo "æ–‡ä»¶ç±»å‹æ£€æŸ¥å®Œæˆ"
                
                # ä»…åœ¨æœ¬åœ°æ„å»ºæ—¶æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
                if [ "${{ matrix.mcp_platform }}" = "native" ]; then
                  echo "æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶: $main_exe"
                  timeout 10s "$main_exe" --help || echo "å¸®åŠ©æµ‹è¯•å®Œæˆ: $main_exe"
                fi
                found_executable=true
                break
              fi
            done
          elif [ -f "$item" ] && [[ "$item" == *"${{ matrix.executable_suffix }}" ]]; then
            # å…¼å®¹å•æ–‡ä»¶æ¨¡å¼
            echo "âœ… æ‰¾åˆ°å•æ–‡ä»¶: $item"
            
            # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            ls -lh "$item"
            file "$item" 2>/dev/null || echo "æ–‡ä»¶ç±»å‹æ£€æŸ¥å®Œæˆ"
            
            # ä»…åœ¨æœ¬åœ°æ„å»ºæ—¶æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
            if [ "${{ matrix.mcp_platform }}" = "native" ]; then
              echo "æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶: $item"
              timeout 10s "./$item" --help || echo "å¸®åŠ©æµ‹è¯•å®Œæˆ: $item"
            fi
            found_executable=true
          fi
        done
        
        if [ "$found_executable" = false ]; then
          echo "âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
          echo "ç›®å½•å†…å®¹:"
          ls -la
          exit 1
        fi
        
        # Linux ç‰¹æ®Šå¤„ç†ï¼šç¡®ä¿æ–‡ä»¶æƒé™æ­£ç¡®
        if [ "${{ matrix.platform }}" = "linux" ]; then
          echo "ğŸ§ Linux æƒé™ä¿®å¤:"
          chmod +x *${{ matrix.executable_suffix }} 2>/dev/null || echo "æƒé™ä¿®å¤å®Œæˆ"
          ls -la *${{ matrix.executable_suffix }} 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
        fi

    # 13. macOS ç‰¹æ®Šå¤„ç†ï¼šæ˜¾ç¤ºæ¶æ„ä¿¡æ¯
    - name: macOS Architecture Info
      if: matrix.platform == 'macos'
      run: |
        echo "ğŸ macOS æ¶æ„ä¿¡æ¯:"
        echo "Runner æ¶æ„: ${{ matrix.arch }}"
        echo "ç³»ç»Ÿæ¶æ„: $(uname -m)"
        echo "Python æ¶æ„: $(python -c 'import platform; print(platform.machine())')"
        
        if [ -d "dist" ]; then
          echo "æ„å»ºäº§ç‰©æ¶æ„éªŒè¯:"
          cd dist
          for exe in *; do
            if [ -f "$exe" ] && [ -x "$exe" ]; then
              echo "æ£€æŸ¥ $exe:"
              file "$exe" || echo "æ–‡ä»¶æ£€æŸ¥å®Œæˆ"
              # åœ¨ macOS ä¸Šæ£€æŸ¥æ¶æ„
              lipo -info "$exe" 2>/dev/null || echo "æ¶æ„æ£€æŸ¥å®Œæˆ"
            fi
          done
        fi
      shell: bash

    # 14. åˆ›å»ºå‘å¸ƒåŒ…
    - name: Create release archive
      shell: bash
      run: |
        echo "ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…..."
        cd dist
        
        # æ˜¾ç¤ºè¦æ‰“åŒ…çš„æ–‡ä»¶
        echo "è¦æ‰“åŒ…çš„æ–‡ä»¶:"
        ls -la
        
        # è°ƒè¯•ï¼šæ˜¾ç¤ºåŒ¹é…æ¨¡å¼å’Œå®é™…æ–‡ä»¶
        echo "åŒ¹é…æ¨¡å¼: *-${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.executable_suffix }}"
        echo "æŸ¥æ‰¾åŒ¹é…çš„æ–‡ä»¶:"
        ls -la *-${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.executable_suffix }} 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ–‡ä»¶"
        echo "æ‰€æœ‰å¯æ‰§è¡Œæ–‡ä»¶:"
        find . -type f -executable 2>/dev/null || echo "æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶å®Œæˆ"
        
        if [ "${{ matrix.platform }}" = "windows" ]; then
          # Windows ä½¿ç”¨ zipï¼Œç¡®ä¿åŒ…å«æ‰€æœ‰æœåŠ¡å™¨æ–‡ä»¶
          if command -v 7z >/dev/null 2>&1; then
            7z a ../${{ matrix.archive_name }}.zip *-${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.executable_suffix }}
          else
            # å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ PowerShellï¼Œæ˜ç¡®æŒ‡å®šæ–‡ä»¶æ¨¡å¼
            powershell -Command "Compress-Archive -Path '*-${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.executable_suffix }}' -DestinationPath '../${{ matrix.archive_name }}.zip'"
          fi
        else
          # Linux å’Œ macOS ä½¿ç”¨ tar.gz
          # ä½¿ç”¨æ›´å®½æ¾çš„åŒ¹é…æ¨¡å¼ï¼ŒåŒ¹é…æ‰€æœ‰å¯æ‰§è¡Œæ–‡ä»¶
          if ls *-${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.executable_suffix }} 1> /dev/null 2>&1; then
            tar -czf ../${{ matrix.archive_name }}.tar.gz *-${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.executable_suffix }}
          else
            echo "è­¦å‘Š: æœªæ‰¾åˆ°åŒ¹é… *-${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.executable_suffix }} çš„æ–‡ä»¶"
            echo "å°è¯•æ‰“åŒ…æ‰€æœ‰å¯æ‰§è¡Œæ–‡ä»¶:"
            ls -la
            # å¤‡ç”¨æ–¹æ¡ˆï¼šæ‰“åŒ…æ‰€æœ‰æ–‡ä»¶
            tar -czf ../${{ matrix.archive_name }}.tar.gz *
          fi
        fi
        
        cd ..
        echo "âœ… åˆ›å»ºçš„å‘å¸ƒåŒ…:"
        ls -lh ${{ matrix.archive_name }}.* || dir ${{ matrix.archive_name }}.*

    # 15. ä¸Šä¼ æ„å»ºäº§ç‰©
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.archive_name }}
        path: |
          ${{ matrix.archive_name }}.*
        retention-days: 30
        if-no-files-found: error

    # 16. æ„å»ºæ‘˜è¦
    - name: Build Summary
      run: |
        echo "âœ… ${{ matrix.platform }}-${{ matrix.arch }} æ„å»ºå®Œæˆ"
        echo "ğŸ“ äº§ç‰©å·²ä¸Šä¼ ä¸º: ${{ matrix.archive_name }}"
        echo "ğŸ”§ ä½¿ç”¨çš„æ„å»ºå¹³å°: ${{ matrix.mcp_platform }}"
      shell: bash

  # æ„å»ºçŠ¶æ€æ‘˜è¦
  build-summary:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Overall Build Summary
      run: |
        echo "ğŸ¯ MCP æœåŠ¡å™¨è·¨å¹³å°æ„å»ºæ‘˜è¦"
        echo "=============================="
        echo "æ„å»ºçŠ¶æ€: ${{ needs.build.result }}"
        echo ""
        echo "ğŸ“¦ æ”¯æŒçš„å¹³å°:"
        echo "- Linux x86_64 (Docker æ„å»º)"
        echo "- Windows x86_64 (Docker æ„å»º)"
        echo "- macOS Intel x86_64 (æœ¬åœ°æ„å»º)"
        echo "- macOS Apple Silicon ARM64 (æœ¬åœ°æ„å»º)"
        echo ""
        if [ "${{ needs.build.result }}" = "success" ]; then
          echo "âœ… æ‰€æœ‰å¹³å°æ„å»ºæˆåŠŸï¼"
        else
          echo "âŒ éƒ¨åˆ†å¹³å°æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi

  # åˆ›å»º GitHub Release
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') && needs.build.result == 'success'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Display downloaded files
      run: |
        echo "ğŸ“¥ ä¸‹è½½çš„æ„å»ºäº§ç‰©:"
        find artifacts/ -type f -name "*" | head -20
        
        echo ""
        echo "ğŸ“Š äº§ç‰©å¤§å°:"
        find artifacts/ -type f -exec ls -lh {} \;

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: artifacts/*/*
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## ğŸš€ MCP Servers Release ${{ github.ref_name }}
          
          æ­¤ç‰ˆæœ¬åŒ…å«ä¸‰ä¸ª MCP æœåŠ¡å™¨çš„è·¨å¹³å°æ„å»ºäº§ç‰©ï¼š
          
          ### ğŸ“¦ åŒ…å«çš„æœåŠ¡å™¨
          - **File Reader Server** - æ–‡ä»¶è¯»å–å’Œé¡¹ç›®ç»“æ„åˆ†ææœåŠ¡
          - **Terminal Manager Server** - ç»ˆç«¯ç®¡ç†å’Œå‘½ä»¤æ‰§è¡ŒæœåŠ¡  
          - **Expert Stream Server** - AIä¸“å®¶å¯¹è¯å’Œå·¥å…·è°ƒç”¨æœåŠ¡
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹
          1. ä¸‹è½½é€‚åˆæ‚¨å¹³å°çš„å‹ç¼©åŒ…
          2. è§£å‹ç¼©æ–‡ä»¶
          3. ç›´æ¥è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼š
             - `./file-reader-server-{platform}-{arch}`
             - `./terminal-manager-server-{platform}-{arch}`
             - `./expert-stream-server-{platform}-{arch}`
          
          ### ğŸ“‹ å¹³å°æ”¯æŒ
          - **Linux x86_64**: `mcp-servers-linux-x86_64.tar.gz`
          - **Windows x86_64**: `mcp-servers-windows-x86_64.zip`
          - **macOS Intel x86_64**: `mcp-servers-macos-intel-x86_64.tar.gz`
          - **macOS Apple Silicon ARM64 (M1/M2/M3)**: `mcp-servers-macos-apple-silicon-arm64.tar.gz`
          
          ### ğŸ”§ æ¶æ„è¯´æ˜
          - **Mac M1/M2/M3 ç”¨æˆ·**: ä½¿ç”¨ `macos-apple-silicon-arm64` ç‰ˆæœ¬ä»¥è·å¾—æœ€ä½³æ€§èƒ½
          - **Intel Mac ç”¨æˆ·**: ä½¿ç”¨ `macos-intel-x86_64` ç‰ˆæœ¬
          - **Windows ç”¨æˆ·**: éœ€è¦ Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - **Linux ç”¨æˆ·**: å…¼å®¹å¤§å¤šæ•°ç°ä»£ Linux å‘è¡Œç‰ˆ
          
          ### ğŸ› ï¸ æŠ€æœ¯ä¿¡æ¯
          - Python ç‰ˆæœ¬: ${{ env.PYTHON_VERSION }}
          - æ„å»ºå·¥å…·: MCP Framework
          - æ„å»ºæ—¶é—´: ${{ github.run_number }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Docker å¤šæ¶æ„æ„å»ºï¼ˆå¯é€‰ï¼‰
  docker:
    name: Build Docker Images
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}
      continue-on-error: true

    - name: Build and push Docker images
      run: |
        echo "ğŸ³ æ„å»º Docker é•œåƒ..."
        echo "æ³¨æ„ï¼šè¿™éœ€è¦åœ¨é¡¹ç›®ä¸­æ·»åŠ é€‚å½“çš„ Dockerfile"
        echo "Docker æ„å»ºå·²è·³è¿‡ï¼Œè¯·æ ¹æ®éœ€è¦æ·»åŠ  Dockerfile"
      continue-on-error: true